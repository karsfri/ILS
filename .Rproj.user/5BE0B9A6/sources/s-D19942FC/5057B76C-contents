

#Load librarys 
library(plyr)
library(dplyr)
library(ggplot2)
library(rmarkdown)
library(readr)
library(lubridate)
library(tidyr)
library(stringr)
library(RJDBC)




#jdbc connect to get data
options(java.parameters = "-Xmx8048m")

drv <- JDBC(driverClass="com.microsoft.sqlserver.jdbc.SQLServerDriver", classPath="/etc/sqljdbc_7.2/enu/mssql-jdbc-7.2.1.jre8.jar")

conn <- dbConnect(drv, url="jdbc:sqlserver://sql02dev.ils.is;DatabaseName=HgrDwh", user="rmc.borkur", password="Brighton123")

query <- "SELECT * from dwh.fact_leigusamningar where dim_timi_fra<getdate()"

#Read in the data
Rentals <- dbGetQuery(conn, query)


dbDisconnect(conn)

# rental leigsam
# kt or kenn 0123  starts 4567etc company

Rentals$Dim_Timi_Thinglyst <- ymd(Rentals$Dim_Timi_Thinglyst)
Rentals$Dim_Timi_Fra <- ymd(Rentals$Dim_Timi_Fra)
Rentals$Dim_Timi_Utgafudagur <- ymd(Rentals$Dim_Timi_Utgafudagur)

Rentals2 <- Rentals %>% 
  mutate(MonthOfRent= floor_date(Dim_Timi_Fra, unit = "months"),
         RentperM= heildarverd/staerd)


# finantial institution or not ? fjarmalastofnun_leigir 
ggplot(Rentals2, aes(MonthOfRent, RentperM)) +geom_line(aes(colour=fjarmalastofnun_leigir))

Rentals$fjarmalastofnun_leigir <- as.character(Rentals$fjarmalastofnun_leigir)

Rentals3 <- Rentals %>%
  filter(Dim_Timi_Fra > ymd("2010-01-01")) %>%
  group_by(month=floor_date(Dim_Timi_Fra, unit = "months"), fjarmalastofnun_leigir ) %>%
  mutate(RentperM = ifelse(staerd>0,heildarverd/staerd, NA)) %>%
  summarise(AvRentperM= mean(RentperM, na.rm=TRUE),
            count=n()) 

Rentals3 %>%
  ggplot(aes(month, AvRentperM)) + geom_line(aes(colour=fjarmalastofnun_leigir)) +
  geom_smooth(aes(colour=fjarmalastofnun_leigir)) + theme_bw() + xlab("Rental Agreement Date") + ylab("Average Rent Per Square Meter")

Rentals3 %>%
  ggplot(aes(month, count)) + geom_line(aes(colour=fjarmalastofnun_leigir)) +
  geom_smooth(aes(colour=fjarmalastofnun_leigir)) + theme_bw() + xlab("Rental Agreement Date") + ylab("Number of rental agreements")





